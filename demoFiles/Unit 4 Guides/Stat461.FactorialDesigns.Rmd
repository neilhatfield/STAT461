---
title: "Factorial Models"
author: "Neil J. Hatfield"
date: "4/15/2022"
output: 
  pdf_document
geometry: left=0.5in,right=0.5in,top=0.5in,bottom=0.5in
urlcolor: blue
header-includes: 
  \usepackage{subfig}
---

```{r setupFiles, echo=FALSE, include = FALSE}
# Setting Document Options
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center"
)

packages <- c("tidyverse", "knitr", "kableExtra",
              "parameters", "hasseDiagram", "car",
              "psych", "DescTools", "emmeans", "openxlsx")
lapply(packages, library, character.only = TRUE)

options(knitr.kable.NA = "")
options(contrasts = c("contr.sum", "contr.poly"))

source("https://raw.github.com/neilhatfield/STAT461/master/rScripts/ANOVATools.R")

```

In this tutorial, we are going to explore Factorial Treatment Structures/Factorial Designs in R. For our purposes here, we will restrict our attention to [full] factorial models with all Fixed Factor Effects. (We will allow for our measurement units to be the only random effect term.) The general structure for this guide will be:

+ Setting Up R
  - Loading Packages, Setting Options, and Additional Tools
+ Data Contexts
  - Load! Aim! Ready! Release! (Gummy Bear Catapult)
  - Battery Manufacturing
+ Exploring the Factorial Treatment Structure
+ Fit the Models
  - Appropriateness of ANOVA
  - Check Interactions
  - Form the Model
+ Assessing Assumptions
  - Gaussian Residuals
  - Homoscedasticity
  - Independence of Observations
+ Results
  - Omnibus
  - Point Estimates
  - Post Hoc--Pairwise and Effect Sizes
  - Post Hoc--Contrasts
+ Dealing with Imbalanced Designs

# Setting Up R

Just as in the prior guides/tutorials, we have to first ensure that `R` is properly configured and prepared for our work. We will want to ensure that we load all of the appropriate packages, set our constraint, and load in any additional tools. 

I've also added in the `psych` package to demonstrate an approach you can use for getting values of descriptive statistics in accordance with the factorial treatment structure. You'll also see the `openxlsx` package in the list; this happens to be my preferred way to read in XLSX files. Feel free to use your own method for reading in Excel files.

As a reminder, the following code does all of these things:

```{r setR, echo=TRUE, eval=FALSE}
# Demo code to set up R
## Load packages
packages <- c("tidyverse", "knitr", "kableExtra",
              "parameters", "hasseDiagram", "car",
              "psych", "DescTools", "emmeans", "openxlsx")
lapply(packages, library, character.only = TRUE)

## Set options and constraint
options(knitr.kable.NA = "")
options(contrasts = c("contr.sum", "contr.poly"))

## Load useful tools
source("https://raw.github.com/neilhatfield/STAT461/master/rScripts/ANOVATools.R")

```

# Data Contexts

For this guide/tutorial, we'll make use of two contexts: __Load! Aim! Ready! Release! (Gummy Bears)__ and __Battery Manufacturing (Batteries)__.

## Load! Aim! Ready! Release! (Gummy Bears)

This data comes from the design that we put together in class to explore the impacts of launch angle and launch position for our spoon-apults for launching gummy bears to see how far they will fly.

```{r loadGummyBears, echo=TRUE}
# Demo code for loading and cleaning data
## Loading gummy bear data
catapultData <- openxlsx::readWorkbook(
  xlsxFile = "https://raw.github.com/neilhatfield/STAT461/master/dataFiles/gummyBears2022.xlsx",
  sheet = 1,
  colNames = TRUE,
  rowNames = FALSE
)

## Change variables
names(catapultData)[which(names(catapultData) == "Launch.Angle")] <- "Angle"
names(catapultData)[which(names(catapultData) == "Launch.Position")] <- "Position"
names(catapultData)[which(names(catapultData) == "Measurement.Order")] <- "Order"

## Fix the data
## R will treat high and High as TWO separate levels
## Same with low & Low, back & Back, and front & Front
catapultData <- catapultData %>%
  dplyr::mutate(
    Angle = dplyr::recode_factor(
      Angle,
      "high" = "High", # Old Value = New Value
      "High" = "High",
      "low" = "Low",
      "Low" = "Low"
    ),
    Position = dplyr::recode_factor(
      Position,
      "back" = "Back",
      "Back" = "Back",
      "front" = "Front",
      "Front" = "Front"
    ),
    Team = dplyr::case_when(
      Team == "Team 6" ~ Team,
      TRUE ~ paste("Team", Team)
    )
  )

```

Notice that I used a couple of functions from `dplyr` to help me clean and take control of the data. The `mutate` function allows you to change an entire column of a data frame in a consistent and relatively speedy way. The `recode_factor` function combines two things: alter values for consistency AND tell `R` to treat the attribute as a factor. Note: the order you list the new values will be the order `R` uses for the factor levels.

### Omnibus SRQs and Hypotheses

Unlike in One-way ANOVA or RCBD with One Factor, we have several SRQs for factorial designs:

+ Does the launch angle make a difference on how far a gummy bear flew?
    - \(H_{1,0}\): There is no statistically significant impact on how far a gummy bear flies due to launch angle.
    - \(H_{1,A}\): There is a statistically significant impact on how far a gummy bear flies due to launch angle.
+ Does the launch position make a difference on how far a gummy bear flew?
    - \(H_{2,0}\): There is no statistically significant impact on how far a gummy bear flies due to launch position.
    - \(H_{2,A}\): There is a statistically significant impact on how far a gummy bear flies due to launch position.
+ Does the interaction of launch angle and position make a difference on how far a gummy bear flew?
    - \(H_{3,0}\): There is no statistically significant interaction effect on how far a gummy bear flies between launch angle and position.
    - \(H_{3,A}\): There is a statistically significant interaction effect on how far a gummy bear flies between launch angle and position.

## Battery Manufacturing

An engineer is designing a battery for use in a device that will people will use in some extreme temperatures. Unfortunately, the engineer may only alter one design parameter: the plate material for the battery of which he has three choices.

The device his batteries are for gets manufactured separately and is then shipped to the field, where the engineer has no control over the temperature the device will encounter. His experiences lead him to believe that environmental temperature will affect the battery life. He can control the temperature in the lab for product development testing.

He decides to test all three plate materials at three temperature levels—15ºF, 70ºF, and 125ºF—as these temperatures are consistent with reported end-use environments.

His questions:

1) What effects do material type and temperature have on life of battery?
2) Is there a choice of material that would give uniformly long life regardless of temperature?

```{r loadBattery, echo=TRUE}
## Demo code for loading and cleaning data
## Load battery data
batteryData <- read.table(
  file = "https://raw.github.com/neilhatfield/STAT461/master/dataFiles/batteryLife.dat",
  header = TRUE,
  sep = ","
)

## Clean data
batteryData$temperature <- dplyr::recode_factor(
  batteryData$temperature,
  `15` = "15ºF",
  `70` = "70ºF",
  `125` = "125ºF"
)
batteryData$material <- dplyr::recode_factor(
  batteryData$material,
  `1` = "Plate 1",
  `2` = "Plate 2",
  `3` = "Plate 3"
)

```

### Your Turn

Write SRQs and hypotheses for the Battery Manufacturing study.

# Exploring the Factorial Treatment Structure

Exploring the data in factorial settings becomes much more important as now you have many more ways to think about slicing up the data resulting in more ways to help people (and yourself) think about the data. Remember, data visualizations are some of your strongest and most helpful tools here. 

## Box Plots Revisited

You can use the multiple factors in a variety of ways in your data visualizations. For example, rather than looking at a side-by-side box plots along one factor, you could do a set for each factor or by the interaction. R's base `boxplot` function allows for you explore interactions by using the formula argument.

```{r interactionBoxplot, fig.cap="Box Plot of Battery Life Spans by Temperature and Plate Material", fig.width=7, fig.height=5, echo=TRUE, fig.pos="H"}
# Demo code for box plots using factorial treatment structure
## Battery Manufacturing
boxplot(
  formula = life ~ temperature:material,
  data = batteryData,
  ylab = "Life (hrs)",
  xlab = "Temp (ºF) x Material"
)

```

While this box plot is okay to look at, we could improve this plot greatly for professional work. The easiest method would be to use `ggplot2`.

```{r boxplots2, echo=TRUE, fig.cap="Box Plot With Multiple Factors--Gummy Bears Study", fig.width=6, fig.height=3, fig.pos="H"}
# Demo code of box plots incorporating factorial treatment structure
## ggplot2 and Gummy Bears Study
ggplot(
  data = catapultData,
  mapping = aes(
    x = Angle,
    y = Distance,
    fill = Position
  )
) +
  geom_boxplot() +
  theme_bw() +
  xlab("Launch Angle") +
  ylab("Distance (in)") +
  labs(
    fill = "Launch Position"
  ) +
  theme(
    legend.position = "right",
    text = element_text(size = 14)
  )

```

## Descriptive Statistics

In addition to data visualizations, we also may make use of descriptive/incisive statistics. We've used the `describeBy` from the `psych` package in the past to break our response up into groups based upon our factor. We can do something similar in multi-factor situations as shown here:

```{r descStatsBattery, echo=TRUE}
# Demo code for descriptive statistics for factorial treatment structure
## Battery Manufacturing 
batteryStats <- psych::describeBy(
  x = batteryData$life,
  # Notice how we're getting the factorial treatments
  group = paste(batteryData$temperature, batteryData$material, sep = " x "),
  na.rm = TRUE,
  skew = TRUE,
  ranges = TRUE,
  quant = c(0.25, 0.75),
  IQR = TRUE,
  mat = TRUE,
  digits = 4
)

batteryStats %>%
  tibble::remove_rownames() %>%
  tibble::column_to_rownames(
    var = "group1"
  ) %>%
  dplyr::select(
    n, min, Q0.25, median, Q0.75, max, mad, mean, sd, skew, kurtosis
  ) %>%
  knitr::kable(
    caption = "Summary Statistics for Battery Life Spans",
    digits = 3,
    format.args = list(big.mark = ","),
    align = rep('c', 11),
    col.names = c("n", "Min", "Q1", "Median", "Q3", "Max", "MAD", "SAM", "SASD",
                  "Sample Skew","Sample Ex. Kurtosis"),
    booktabs = TRUE
  )  %>%
  kableExtra::kable_styling(
    font_size = 12,
    latex_options = c("HOLD_position", "scale_down")
  ) 

```

If you are using `dplyr`'s `summarize` function, you can achieve similar results by first calling `group_by` and then listing all of your factors. In this case we would want `dplyr::group_by(temperature, material)`.

```{r descStatsGummyBears, echo=TRUE}
# Demo code for descriptive statistics for factorial treatment structure
## Gummy Bears 
catapultData %>%
  dplyr::group_by(Angle, Position) %>%
  summarize(
    n = n(),
    min = min(Distance),
    Q1 = quantile(Distance, probs = c(0.25)),
    med = median(Distance),
    Q3 = quantile(Distance, probs = c(0.75)),
    max = max(Distance),
    mad = mad(Distance),
    sam = mean(Distance),
    sd = sd(Distance),
    skew = psych::skew(Distance),
    kurtosis = psych::kurtosi(Distance)
  ) %>%
  knitr::kable(
    caption = "Summary Statistics for Gummy Bear Study",
    digits = 3,
    format.args = list(big.mark = ","),
    align = rep('c', 13),
    col.names = c("Angle", "Position", "n", "Min", "Q1", "Median", "Q3", "Max", "MAD",
                  "SAM", "SASD", "Sample Skew","Sample Ex. Kurtosis"),
    booktabs = TRUE
  )  %>%
  kableExtra::kable_styling(
    font_size = 12,
    latex_options = c("HOLD_position", "scale_down")
  ) 

```

Either approach (`psych::describeBy` or `dplyr::group_by` and `dplyr::summarize`) works for getting values of descriptive statistics in accordance to the factorial treatment structure.

# Fit the Models

Before we write code to fit the factorial model in `R`, we should do two things: 1) double check that a factorial ANOVA approach is appropriate, and 2) check for interactions.

## Appropriateness of ANOVA

As we have been doing since Unit 3, checking for whether ANOVA methods are appropriate for answering our SRQ comes down to the following:

+ Do we have a quantitative response?
+ Do we have two or more categorical/qualitative factors? (If only one, then we're not factorial ANOVA.)
+ Do we have enough *Degrees of Freedom* to be able to estimate the Main Effects and Interactions?
+ Do we have enough *Degrees of Freedom* for estimating residuals/errors?
+ (For Main Effects Only Models: do we have an additive model?)

As before, our knowledge of the study design and the Hasse diagram can help us out.

Figure \ref{fig:batteriesHD} shows the Hasse diagram for the Battery Manufacturing study. We know that the response is quantitative (number of hours of life). From the Hasse diagram, we have two factors (Plate Material and Temperature) which are both categorical. We are doing a full factorial structure (we have all possible interactions). Further, since we have positive *Degrees of Freedom* for each node in the Hasse diagram, we know that we should be able to estimate all main effects, interactions, and the residuals/errors.

```{r batteriesHD, fig.cap="Hasse Diagram for Battery Manufacturing Study", fig.height=2, fig.pos="H"}
# Hasse Diagram
modelLabels <- c("1 Maintain Charge 1", "3 Plate 2", "3 Temperature 2",
                 "9 Plate × Temperature 4", "36 (Batteries) 27")
modelMatrix <- matrix(
  data = c(FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, FALSE, TRUE,
           FALSE, FALSE, FALSE, FALSE, TRUE, TRUE, TRUE, FALSE, FALSE, TRUE, TRUE,
           TRUE, TRUE, FALSE),
  nrow = 5,
  ncol = 5,
  byrow = FALSE
)
hasseDiagram::hasse(
 data = modelMatrix,
 labels = modelLabels
)

```

### Your Turn

Create a similar paragraph as I did but for the Gummy Bears situation.

## Check Interactions

With a [Full] Factorial Design, we no longer have a truly additive model. The interaction term, in some ways, is a measure of how far our model departs from additivity. We want to see whether interactions are important or unimportant: data visualizations are our key to detect this. However, unlike with One-way ANOVA with a Block, we will not worry if we see interactions.

There are several ways that we can look at interaction plots. In the guide/tutorial on Block designs, we saw a way that we can use the `ggplot2` package to create an interaction plot. However, there is also a method that uses Base `R` (i.e., no extra packages).

### Base `R` Interaction Plot 

The function `interaction.plot` is part of the basic setup of `R` (included in the default `stats` package). This function allows us to explore the interaction between __TWO__ factors at a time. This does mean that if you want to try to explore a three-way interaction, this method won't work. 

```{r batteryInt1, fig.cap="Interaction Plot using base R", fig.width=6, fig.height=3.5, echo=TRUE, fig.pos="H"}
# Demo code for using base R to create an interaction plot
## Battery Manufacturing Study
interaction.plot(
  x.factor = batteryData$temperature, # First Factor
  trace.factor = batteryData$material, # Second Factor
  response = batteryData$life, # Response
  fun = mean,
  type = "b", # Both points and lines
  col = c("black","red","blue"), # Set colors for trace
  pch = c(19, 17, 15),  # Set symbols for trace
  fixed = TRUE,
  legend = TRUE,
  xlab = "Operating Temperature",
  ylab = "Life Span (hours)",
  trace.label = "Plate Material")

```

For a plot from base `R`, this is actually a pretty decent. Remember, we're looking to see if as we move through the levels of one factor (operating temperature) and through the levels of the other factor (plate material), what appears to be happening to the response (life span). If there is no interaction, then we should see consistent behaviors throughout (perfect world of no interaction would have parallel line segments). The more inconsistent the behavior (for example, complete reversal of behavior, perpendicular line segments), the more impactful the interaction is between the two factors

#### Example Write up

From Figure \ref{fig:batteryInt1}, we can see that there is some interaction between the operating temperature and plate material. For example, going from 15ºF to 70ºF, produced a drop in life span for materials one and two but for plate three there is a slight increase in life span. As we move from room temperature (70ºF) to the high of 125ºF, this time plate material one appears to hold steady in life span while the other two materials experience drops in life span.

### Using `ggplot2` for Interaction Plots

As we saw in the Block guide/tutorial, we can use `ggplot2` to create an interaction plot. Again, you want to have some care here for how many factors you want to explore at any one time. With `ggplot2` you can move beyond two factors at a time, but be careful; you don't want to overwhelm your audience.

In the following example, I'm going to create an interaction plot for launch angle and launch position, but I'm also going to place the observations on the graph so we can also get a sense of variation that gets hidden by the trend lines.

```{r catapultInteraction1, fig.cap="Interaction Plot for Gummy Bears Study", fig.width=6, fig.height=3.5, echo=TRUE, fig.pos="H"}
# Demo code for using ggplot to make interaction plot w/observations showing
## Gummy Bears Study
ggplot(
  data = catapultData,
  mapping = aes(
    x = Angle,
    y = Distance,
    shape = Position,
    color = Position,
    linetype = Position,
    group = Position
  )
) +
  stat_summary(fun = "mean", geom = "point", size = 3) +
  stat_summary(fun = "mean", geom = "line", size = 1) +
  geom_jitter(width = 0.1, height = 0.1, alpha = 0.25, size = 1) +
  ggplot2::theme_bw() +
  xlab("Launch Angle") +
  ylab("Distance (in)") +
  labs(
    color = "Launch Position",
    shape = "Launch Position",
    linetype = "Launch Position"
  ) +
  scale_color_manual(values = c("red", "blue")) +
  theme(
    legend.position = "bottom",
    text = element_text(size = 12)
  )

```

Whether you use the interaction plot code laid out in the Block guide/tutorial, the base `R` approach, or this most recent version is entirely up to you. What you want to be sure of is that the visualization helps you and your audience gain a deeper understanding of the data and context for the SRQ. You also want to make sure that the data visualization looks good.

### Your Turn

Write up a paragraph that goes with Figure \ref{fig:catapultInteraction1}.

## Form the Model

Once we've verified that a factorial ANOVA model is appropriate and made a decision about including interaction terms\footnote{There is no harm in keeping interaction terms in the model, even if you don't think there is an interaction...provided you have sufficient \textit{Degrees of Freedom}.}, we can turn our attention to forming the model in `R`.

There are a couple of different ways that you can specify factorial designs in `R`: you can manually type in the main the effects and interactions in the order you wish OR you can let `R` fill in all of the terms for you. 

For `R`, to specify a main effect, you simply type the name of the factor in the formula just as we have been doing all semester.

For an interaction, you'll type the names of __all__ main effects involved in the interaction, separating each name with a colon (:). For example, if we wanted the two-way interaction of A and B, we would type `A:B`; for a three-way interaction of A, B, and C, we would type `A:B:C`.

To have `R` automatically fill in all terms, you simply list each main effect and use `*` to separate terms. Thus, typing `y ~ A*B` is the same as `y ~ A + B + A:B`. Notice that in the `formula` argument the `*` symbol can take on multiple meanings: multiplication as in `2*A` and factorial expansion as in `A*B` going to `A + B + A:B`. 

I'll show both approaches here:

```{r factorialModels, echo=TRUE}
# Demo code for forming the factorial models
## Fitting by hand--Battery Manufacturing Study
batteryModel <- aov(
  formula = life ~ temperature + material + temperature:material,
  data = batteryData
)

## Letting R handle the expansion--Gummy Bears Study
catapultModel <- aov(
  formula = Distance ~ Angle*Position,
  data = catapultData
)

```


# Assessing Assumptions

For the parametric shortcut for factorial designs (the ANVOA *F* test), we have the same three assumptions as in the One-way case: Gaussian Residuals, Homoscedasticity, and Independence of Observations. We will assess them in the same ways as we have before.

## Gaussian Residuals

Use a QQ plot like usual:

```{r residualQQ, fig.cap="QQ Plot for Residuals in Battery Manufacturing Study", fig.width=5, fig.height=3.5, echo=TRUE, fig.pos="H"}
# Demo code for QQ plot
# Battery Manufacturing
car::qqPlot(
  x = residuals(batteryModel), 
  distribution = "norm",
  envelope = 0.90,
  id = FALSE,
  pch = 20,
  ylab = "Residuals (hours)"
)

```

There is very little to be concerned about in our QQ plot; we will go ahead and proceed as if our residuals follow a Gaussian distribution.

### Your Turn

Build a QQ plot and write accompanying text for assessing the Gaussian Residuals assumption for the Gummy Bears Study.

## Homoscedasticity

Just as in the One-way ANOVA with a Block, we will want to look at a Tukey-Anscombe plot rather than a strip chart for our factorial designs.

```{r batteryVar, fig.cap="Tukey-Anscombe Plot for Battery Manufacturing Study", fig.width=4, fig.height=3, echo=TRUE, fig.pos="H"}

ggplot(
  data = data.frame(
    residuals = residuals(batteryModel),
    fitted = fitted.values(batteryModel)
  ),
  mapping = aes(x = fitted, y = residuals)
) +
  geom_point(size = 2) +
  geom_hline(
    yintercept = 0,
    linetype = "dashed",
    color = "grey50"
  ) +
  geom_smooth(
    formula = y ~ x,
    method = stats::loess,
    method.args = list(degree = 1),
    se = FALSE,
    size = 0.5
  ) +
  theme_bw() +
  xlab("Fitted values (hours)") +
  ylab("Residuals (hours)")

```

The first thing that I notice in the Tukey-Anscombe plot (Figure \ref{fig:batteryVar}) is that the fourth strip from the left shows the least amount of variation while the fifth strip (from the left) shows the most. The fifth used more than twice the vertical space as the fourth, however, this is the only aspect that causes me a moment of hesitation. There are no discernible patterns to the plot and the blue reference line is perfectly horizontal indicating that we have [sufficient] homoscedasticity.

### Your Turn

Create the appropriate plot and associated text for the Gummy Bear study.

## Independence of Observations

For Independence of Observations, keep in mind that our Go To is to think about the study design. If we happen to know measurement order, then we can make use of an index plot and the DW statistic.

### Battery Manufacturing Study

Unfortunately, we don't know measurement order in the Battery Manufacturing study, so index plots are not going to be useful here. However, we can think through the study design and reach a decision about independent observations.

In this particular case, we know that the the application of plate material was randomly assigned to instances of battery building process and that a set of batteries using each plate material were selected via a random process. Within each of those sets, the engineer assigned an operating temperature to each battery. Taken together, this information does not raise any flags that we have dependent observations based upon the design.

### Gummy Bears Study

We do know measurement order for the Gummy Bears study...except that there is one slight wrinkle. We have 12 different "first" gummy bears launched and measured. To explore whether we have any violation of the Independence of Observations, we are going to need to think through the study design and make use of the measurement order.

What do we know about how the study was designed? Quite a bit, after all, we designed the study! We will take the 300 gummy bears as constituting a random sample from the population of gummy bears created by the manufacturer. While not a rigorous random process, Neil did draw individual gummy bears from a central stock pile to separate them into 12 groups of 25. We also know that we randomly assigned the treatments to catapult teams (our experimental units) and they arbitrarily took one of the bags of gummy bears. Taken together, we might take these facts as suggesting that we have independent observations __*up to the point the catapult teams took possession of the baggies of gummy bears*__.

I happen to know that at least one group did not use all 25 gummy bears; rather they used a couple of gummy bears and repeated launched and measured them. This is a threat to Independence of Observations. To explore, we will look at index plots...broken out by each experimental unit (catapult teams).

```{r gummyBearsIO, fig.cap="Index Plots for Gummy Bear Study", fig.width=7, fig.height=4, echo=TRUE}
ggplot(
  data = catapultData,
  mapping = aes(
    x = Order,
    y = Distance
  )
) +
  geom_point(size = 0.5) +
  geom_line() +
  theme_bw() +
  xlab("Measurement order") +
  ylab("Distance (in)") +
  facet_wrap(
    . ~ Team
  )

```

Figure \ref{fig:gummyBearsIO} shows the index plots for the twelve catapult teams. I am going to leave to you the challenge of getting `R` to place the facets in the order Team 1, Team 2, Team 3, etc. instead of what currently appears.

When I look at Figure \ref{fig:gummyBearsIO}, I don't see twelve perfect carbon copies. This supports the idea that the twelve experimental units are independent. The two plots I'm most concerned about are Team 4, Team 8, and Team 9. In Team 4's plot, we have a run of increasing distances from launch 19 through launch 24. For Team 8, they reached a point where a general upward trend shows up starting launch 12; similarly for Team 9 around launch 11. I suspect that in these cases, the team got into a "groove" or rhythm. While in some circumstances this might be more problematic, given our context, we'll survive.

## Recapping Assumptions

We will state that all three assumptions are satisfied for both the Battery Manufacturing and Gummy Bears studies.

# Results

For results, we want to tackle both sets: Omnibus (*F* test, effect sizes, and point estimates) and Post Hoc (pairwise, effect sizes, and/or contrasts).

## Omnibus

For the Battery Manufacturing and Gummy Bears studies, we have __balanced__ designs. Thus, we do not need to worry about different types of *Sums of Squares*. However, I'm going to demonstrate how we can switch the types.

```{r batteryTable, echo=TRUE}
# Omnibus Test/Modern ANOVA Table
parameters::model_parameters(
    model = batteryModel,
    omega_squared = "partial", # Notice the use of partial
    eta_squared = "partial",
    epsilon_squared = "partial",
    type = 1, # Use 1, 2, or 3 for the Type of SSQs you want
    drop = "(Intercept)", # Drop an unneeded row for ANOVA
    verbose = FALSE # Makes the function "quiet"
) %>%
  dplyr::mutate(
    p = ifelse(
      test = is.na(p),
      yes = NA,
      no = pvalRound(p)
    )
  ) %>%
  knitr::kable(
    digits = 4,
  col.names = c("Source", "SS", "df", "MS", "F", "p-value",
                "Partial Omega Sq.", "Partial Eta Sq.", "Partial Epsilon Sq."),
  caption = "ANOVA Table for Battery Manufacturing Study",
  align = c('l',rep('c',8)),
  booktab = TRUE
) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = c("scale_down", "HOLD_position")
  )

```

Table \ref{tab:batteryTable} gives us a modern ANOVA table for our full factorial in the Battery Manufacturing Study. Unlike for RCBD, we care about all of the rows this time. We interpret the *F*-ratio just as we have done previously. Same goes for the *p*-values. Supposing that we set \(UT=0.05\), we still use the *p*-values from the table in the regular way to make decisions between the hypotheses. 

The effect sizes (partial omega/eta/epsilon-squared values) are still proportions of variation in the response explained and we can use the regular Rules of Thumb for qualitative sizing. The biggest catch is to recognize that these aren't *unique* explanations of variance.

In the Battery Manufacturing situation, we would decide to reject the null hypothesis for each of the main effects and for the interaction term. Of these, temperature appears to explain most of the variation in battery life.

### Your Turn

Make the modern ANOVA table for the Gummy Bears situation. Write a paragraph to go with the table.

## Point Estimates

You can get point estimates for your main effects and treatment effects using the `dummy.coef` function. 

```{r batteryPointEstimates, echo=TRUE}
# Demo code for Point Estimates 
## Battery Manufacturing Study
pointEst <- dummy.coef(batteryModel)
pointEst <- unlist(pointEst)
names(pointEst) <- c(
  "Grand Mean",
  levels(batteryData$temperature),
  levels(batteryData$material),
  outer(
    levels(batteryData$temperature),
    levels(batteryData$material),
    FUN = paste,
    sep = " x "
  )
)

data.frame("Estimate" = pointEst) %>%
  knitr::kable(
  digits = 2,
  caption = "Point Estimates from the Song Knowledge Study",
  booktabs = TRUE,
  align = "c"
  ) %>%
  kableExtra::kable_styling(
    font_size = 12,
    latex_options = c("HOLD_position")
  ) 

```

I will make no claims that Table \ref{tab:batteryPointEstimates} is the most efficient way to present the point estimates. I'll leave how to better parse this table to you all.

What I will highlight is that the interpretations of the *GSAM* and the main effects remain consistent with what we've worked with previously. For example, ignoring all factors, our batteries lasted 105.53 times as long as the number of batteries we tested (i.e., the common baseline performance). At 70ºF, the battery's performance was an additional 2.06 hours/battery greater than the common baseline. However, Plate 1 batteries had a reduction of 22.36 hours/battery from baseline.

The interpretation of interaction terms may be thought of as the "differences in differences" for performances or as how much we have to moderate the performance of a group from just the main effects? That is to say, how much does the battery performance change due to the interaction of the two factors. For example, let's consider Plate 1 and 15ºF. The performance for the batteries in this group starts with baseline (105.53 hrs/battery) and gets a bonus for 15ºF (+39.31 hrs/battery). However, this group also has a performance penalty for Plate 1 (-22.36 hrs/battery). However, the interaction of 15ºF and Plate 1 moderates the performance penalty by giving back 12.28 hrs/battery. If we add these rates together, \(105.53+39.31-22.36+12.28\approx `r 105.53+39.31-22.36+12.28`\), which is equal (up to rounding) to the value of the *SAM* we saw for this group in Table \ref{tab:descStatsBattery} or will see in Table \ref{tab:batteryPH1}.

### Your Turn

Get the point estimates for the Gummy Bear Study. Give interpretations for the *GSAM*, one level of each main effect, and one interaction level.

## Post Hoc--Pairwise Comparisons & Effect Sizes

While you *could* use the pairwise comparison functions we've previously used, a better approach is to embrace our Factorial Design and look at the *estimated marginal means*. These will hold certain factors constant and let others vary. To do this, we will need to use the `emmeans` package.

```{r batteryPH1, echo=TRUE}
# Demo code for Post Hoc 
## Marginal Means with Adjusted Confidence Intervals
## Battery Manufacturing Study
batteryPHMeans <- emmeans::emmeans(
  object = batteryModel,
  # The order of factors does not really matter for this
  specs = pairwise ~ temperature | material,
  adjust = "tukey", # Where you specify your chosen method
  level = 0.9 # 1--Type I Risk
)

as.data.frame(batteryPHMeans$emmeans) %>%
  knitr::kable(
    digits = 4,
    col.names = c("Temperature", "Plate Material", "Marginal Mean","SE", "DF",
                  "Lower Bound","Upper Bound"),
    caption = "Marginal Means-Tukey 90\\% Adjustment",
    align = rep("c", 7),
    booktabs = TRUE
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = c("HOLD_position")
  )

```

```{r batteryPH2, echo=TRUE}
# Demo code for Post Hoc 
## Pairwise Comparisons
## Battery Manufacturing Study
batteryPHTemp <- emmeans::emmeans(
  object = batteryModel,
  # Order maters for this; comparisons | held constant
  specs = pairwise ~ temperature | material,
  adjust = "tukey", # Where you specify your chosen method
  level = 0.9 # 1--Type I Risk
)

as.data.frame(batteryPHTemp$contrasts) %>%
  knitr::kable(
    digits = 4,
    col.names = c("Comparison", "Plate Material", "Estimate","SE", "DF",
                  "t Statistic", "p-value"),
    caption = "Pairwise Comparisons of Temperature-Tukey 90\\% Adjustment",
    align = rep("c", 7),
    booktabs = TRUE
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = c("HOLD_position")
  )

```

```{r batteryPH3, echo=TRUE}
# Demo code for Post Hoc 
## Pairwise Comparisons
## Battery Manufacturing Study
batteryPHPlate <- emmeans::emmeans(
  object = batteryModel,
  # Order maters for this; comparisons | held constant
  specs = pairwise ~ material | temperature,
  adjust = "tukey", # Where you specify your chosen method
  level = 0.9 # 1--Type I Risk
)

as.data.frame(batteryPHPlate$contrasts) %>%
  knitr::kable(
    digits = 4,
    col.names = c("Comparison", "Temperature", "Estimate","SE", "DF",
                  "t Statistic", "p-value"),
    caption = "Pairwise Comparisons of Plate Material-Tukey 90\\% Adjustment",
    align = rep("c", 7),
    booktabs = TRUE
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = c("HOLD_position")
  )

```

The `adjust` argument of `emmeans` allows values as your method for controlling Type I Error rates: `"bonferroni"`, `"tukey"`, `"scheffe"`, `"sidak"`, `"holm"`, `"hochberg"`, `"hommel"`, `"BH"` (Benjamini and Hochberg), and `"fdr"`. You will get point estimates (marginal means) and their confidence intervals when you use the `postHocObject$emmeans` and you'll get pairwise comparisons with adjusted *p*-values when you use `postHocObject$contrasts`.

### Effect Sizes

Unfortunately, my `anova.PostHoc` function does not currently work with with factorial models. However, the `emmeans` package provides us with a way to get Cohen's *d*, which then allows us to my `probSup` function to get the Probability of Superiority.

```{r effectSize1, echo=TRUE}
# Demo Code for Effect Sizes
## Battery Manufacturing Study
## Pairwise Temperature Comparisons
as.data.frame(
  eff_size(
    object = batteryPHTemp,
    sigma = sigma(batteryModel),
    edf = df.residual(batteryModel)
  ) 
) %>%
  dplyr::mutate(
    ps = probSup(effect.size),
    .after = effect.size
  ) %>%
  dplyr::select(contrast, material, effect.size, ps) %>%
  knitr::kable(
    digits = 3,
    col.names = c("Comparison", "Plate Material", "Cohen's d", "Probability of Superiority"),
    align = "lccc",
    caption = "Effect Sizes for Temperature",
    booktab = TRUE
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = "HOLD_position"
  )

```

```{r effectSize2, echo=TRUE}
# Demo Code for Effect Sizes
## Battery Manufacturing Study
## Pairwise Plate Material Comparisons
as.data.frame(
  eff_size(
    object = batteryPHPlate,
    sigma = sigma(batteryModel),
    edf = df.residual(batteryModel)
  ) 
) %>%
  dplyr::mutate(
    ps = probSup(effect.size),
    .after = effect.size
  ) %>%
  dplyr::select(contrast, temperature, effect.size, ps) %>%
  knitr::kable(
    digits = 3,
    col.names = c("Comparison", "Temperature", "Cohen's d", "Probability of Superiority"),
    align = "lccc",
    caption = "Effect Sizes for Plate Material",
    booktab = TRUE
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = "HOLD_position"
  )

```

You would interpret these effects sizes exactly as you would in a One-way ANOVA context. 

You can also see a bit of the influence of the interaction terms. Look at Table \ref{tab:effectSize2} and the Plate 1 - Plate 2 values across the three temperatures. Notice that the effect changes with the operating temperature.

## Post Hoc--Contrasts

While not all that common, especially if you are using a model building perspective, you can still do contrasts with factorial designs. 

For contrasts involving combinations of levels of a single factor, you would use the same approaches and methods as in the One-way ANOVA case. 

Contrasts involving combinations of levels of interaction terms are not straightforward. My recommendation is that you think extremely carefully as to what the purpose of such a combination is and whether there are other ways to investigate.

# Imbalanced Designs

As mentioned in class, when you have imbalanced designs for factorial models, we have to make a decision about which type of Sums of Squares we want to use.

## Different Types of Sums of Squares

We have three types of Sums of Squares. Keep in mind that the default is Type I for the `aov` call. Most often in Factorial ANOVA settings, we are interested in Type II (model building--watch out of important interaction terms) and Type III (for testing differences amongst factor levels).

For all of these we can use the `type` argument of the `model_parameters` function that we use for our modern ANOVA tables.

## Quick Example

For this example, I'm going to use a data set on different training methods' (fixed, 2 levels) and engery drink's (fixed, 2 levels) impacts on the time to run around a particular track.

Look at how the various values change across the tables.

```{r runningData, echo=TRUE}
# Demo Code of Imbalanced Designs
# Load Running Data
running <- read.table(
  file = "http://stat.ethz.ch/~meier/teaching/data/running.dat", 
  header = TRUE
)

running$method <- as.factor(running$method)
running$drink <- as.factor(running$drink)

# Fit the anova model--same as usual
runningModel <- aov(
  formula = y ~ method*drink, # R interprets this as y ~ method + drink + method:drink
  data = running
)

```

```{r runningType1, echo=TRUE}
# Demo Code
# Type I SSQs
parameters::model_parameters(
    model = runningModel,
    omega_squared = "partial", 
    eta_squared = "partial",
    epsilon_squared = "partial",
    type = 1, # Type I SSQs
    drop = "(Intercept)", 
    verbose = FALSE 
) %>%
  dplyr::mutate(
    p = ifelse(
      test = is.na(p),
      yes = NA,
      no = pvalRound(p)
    )
  ) %>%
  knitr::kable(
    digits = 4,
  col.names = c("Source", "SS", "df", "MS", "F", "p-value",
                "Partial Omega Sq.", "Partial Eta Sq.", "Partial Epsilon Sq."),
  caption = "ANOVA Table for Running-Type I SSQs",
  align = c('l',rep('c',8)),
  booktab = TRUE
) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = c("scale_down", "HOLD_position")
  )

```

```{r runningType2, echo=TRUE}
# Demo Code
# Type II SSQs
parameters::model_parameters(
    model = runningModel,
    omega_squared = "partial", 
    eta_squared = "partial",
    epsilon_squared = "partial",
    type = 2, # Type II SSQs
    drop = "(Intercept)", 
    verbose = FALSE 
) %>%
  dplyr::mutate(
    p = ifelse(
      test = is.na(p),
      yes = NA,
      no = pvalRound(p)
    )
  ) %>%
  knitr::kable(
    digits = 4,
    col.names = c("Source", "SS", "df", "MS", "F", "p-value",
                  "Partial Omega Sq.", "Partial Eta Sq.", "Partial Epsilon Sq."),
    caption = "ANOVA Table for Running-Type II SSQs",
    align = c('l',rep('c',8)),
    booktab = TRUE
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = c("scale_down", "HOLD_position")
  )

```

```{r runningType3, echo=TRUE}
# Demo Code
# Type III SSQs
parameters::model_parameters(
  model = runningModel,
  omega_squared = "partial", 
  eta_squared = "partial",
  epsilon_squared = "partial",
  type = 3, # Type III SSQs
  drop = "(Intercept)", 
  verbose = FALSE 
) %>%
  dplyr::mutate(
    p = ifelse(
      test = is.na(p),
      yes = NA,
      no = pvalRound(p)
    )
  ) %>%
  knitr::kable(
    digits = 4,
    col.names = c("Source", "SS", "df", "MS", "F", "p-value",
                  "Partial Omega Sq.", "Partial Eta Sq.", "Partial Epsilon Sq."),
    caption = "ANOVA Table for Running-Type III SSQs",
    align = c('l',rep('c',8)),
    booktab = TRUE
  ) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "condensed"),
    font_size = 12,
    latex_options = c("scale_down", "HOLD_position")
  )


```



\newpage

# Code Appendix

```{r codeAppendix, ref.label = knitr::all_labels(), echo = TRUE, eval = FALSE}

```